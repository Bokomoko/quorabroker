(window.ansFrontendRelayWebpackJsonpFunction=window.ansFrontendRelayWebpackJsonpFunction||[]).push([["lib-broadcast"],{"4JlD":function(e,t,n){"use strict";var s=function(e){switch(typeof e){case"string":return e;case"boolean":return e?"true":"false";case"number":return isFinite(e)?e:"";default:return""}};e.exports=function(e,t,n,a){return t=t||"&",n=n||"=",null===e&&(e=undefined),"object"===typeof e?o(r(e),(function(r){var a=encodeURIComponent(s(r))+n;return i(e[r])?o(e[r],(function(e){return a+encodeURIComponent(s(e))})).join(t):a+encodeURIComponent(s(e[r]))})).join(t):a?encodeURIComponent(s(a))+n+encodeURIComponent(s(e)):""};var i=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)};function o(e,t){if(e.map)return e.map(t);for(var n=[],s=0;s<e.length;s++)n.push(t(e[s],s));return n}var r=Object.keys||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t}},VHT1:function(e,t,n){"use strict";n.r(t),n.d(t,"getID",(function(){return _})),n.d(t,"setID",(function(){return b})),n.d(t,"processBroadcastData",(function(){return g})),n.d(t,"hashQueryHashWithVars",(function(){return k})),n.d(t,"Broadcast",(function(){return T})),n.d(t,"collectLiveCategories",(function(){return q}));var s=n("J4zp"),i=n.n(s),o=n("SKAY"),r=n("8lmh"),a=n("Pp7N"),c=n("peAK"),d=n("mVMq"),l=n("ZXlt"),h=n("J7yc"),u=n("sEfC"),f=n.n(u),y=n("qy3/"),p=n("h39y");const _=()=>T.id,b=e=>{T.id||(T.id=e)},g=e=>{const t=e.categoryToDepkeys,n=e.depkeyToVersion,s=e.dirtiedDepkeyToVersion;t&&a.c.dispatch({type:a.a.LIVE_CATEGORY_TO_DEPKEYS_RECEIVED,payload:{categoryToDepkeys:t}}),n&&a.c.dispatch({type:a.a.DEPKEYS_RECEIVED,payload:{depkeyToVersion:n,ignoreNewDepkey:!1}}),s&&a.c.dispatch({type:a.a.DEPKEYS_RECEIVED,payload:{depkeyToVersion:s,ignoreNewDepkey:!0}})},k=e=>{let t=e.queryHash,n=e.variables;const s=Object(y.b)(n);return`${t}:${JSON.stringify(s,Object.keys(s).sort())}`},v=e=>e.split(":",3).join(":"),m=e=>{var t,n,s,i,o,r,a;return e["default"]&&(e=e["default"]),"Request"===(null===(t=e)||void 0===t?void 0:t.kind)?e:"Fragment"!==(null===(n=e)||void 0===n?void 0:n.kind)?null:null===(s=e)||void 0===s||null===(i=s.metadata)||void 0===i||null===(o=i.reloadable)||void 0===o||null===(r=o.operation)||void 0===r||null===(a=r.queryOrNull)||void 0===a?void 0:a.call(r)};class T{constructor(){this.depkeyToVersion=void 0,this.depkeyToCategories=void 0,this.queryHashToGqlQuery=void 0,this.categoryToGqlQueries=void 0,this.pendingGqlQueries=void 0,this.debounceExecutePendingGqlQueries=void 0,this.depkeyToVersion={},this.depkeyToCategories={},this.queryHashToGqlQuery={},this.categoryToGqlQueries={},this.pendingGqlQueries={},this.debounceExecutePendingGqlQueries=f()(async()=>{const e=this.pendingGqlQueries;this.pendingGqlQueries={},await this._executeGqlQueries(e)},300);const e=Object(o.getSetting)("broadcastId"),t=Object(o.getSetting)("tchannelData");null===T.id&&e&&(T.id=e),t&&Object(l.start)(t),Object(l.setBeforeReconnectionFn)(this.refreshStaleDepkeys.bind(this)),Object(l.subscribe)("broadcastReloadDirtiedDepkeys",e=>{if(!e.dirtied_depkeys)return;const t={};for(const s of e.dirtied_depkeys){var n=i()(s,2);const e=n[0],o=n[1];t[e]=o}this.processDepkeyToNewVersion(t)}),a.c.subscribe(a.a.LIVE_CATEGORY_TO_DEPKEYS_RECEIVED,e=>{var t;if(!e||!("payload"in e))return;const n=(null!==(t=e.payload)&&void 0!==t?t:{}).categoryToDepkeys;n&&this.processCategoryToDepkeys(n)}),a.c.subscribe(a.a.DEPKEYS_RECEIVED,e=>{var t;if(!e||!("payload"in e))return;const n=null!==(t=e.payload)&&void 0!==t?t:{},s=n.depkeyToVersion,i=n.ignoreNewDepkey,o=void 0!==i&&i;s&&this.updateDepkeyToNewVersion(s,o)}),Object(h.a)("WEBNODE_BROADCAST_DIRTIED_DEPKEYS",e=>{var t;if(!e||!("payload"in e))return;const n=null===(t=e.payload)||void 0===t?void 0:t.dirtied_depkeys;if(!n)return;const s={};for(const r of n){var o=i()(r,2);const e=o[0],t=o[1];s[e]=t}this.processDepkeyToNewVersion(s,!1,!0)})}updateDepkeyToNewVersion(e){let t=arguments.length>1&&arguments[1]!==undefined&&arguments[1];for(const n in e){const s=this.depkeyToVersion[n];if(s===undefined&&t)continue;const i=e[n];(s===undefined||i>s)&&(this.depkeyToVersion[n]=i)}}processDepkeyToNewVersion(e){let t=arguments.length>1&&arguments[1]!==undefined&&arguments[1],n=arguments.length>2&&arguments[2]!==undefined&&arguments[2];if(!e)return;const s={};for(const i in e){const o=this.depkeyToVersion[i];if(o===undefined&&n)continue;const r=e[i];if(t||o===undefined||!(r<=o)){this.depkeyToVersion[i]=r;for(const e in this.depkeyToCategories[i])for(const t in this.categoryToGqlQueries[e]){if(t in s)continue;const n=this.categoryToGqlQueries[e][t];s[t]=n}}}this.executeGqlQueries(s)}processCategoryToDepkeys(e){if(0!==Object.keys(e).length)for(const t in e){const n=v(t);for(const s of e[t])s in this.depkeyToCategories||(this.depkeyToCategories[s]={}),this.depkeyToCategories[s][n]=!0}}async _executeGqlQueries(e){if(0===Object.keys(e).length||Object(o.getSetting)("broadcastDisabled"))return;const t=[];for(const n in e){const s=e[n],i=s.queryHash,o=s.variables;if(!i)continue;const r=this.queryHashToGqlQuery[i];r&&t.push({query:r,variables:o})}await Promise.all(t.map(e=>{let t=e.query,n=e.variables;return Object(p.fetchQuery_DEPRECATED)(c["default"],t,n)}))}async executeGqlQueries(e){for(const t in e)t in this.pendingGqlQueries||(this.pendingGqlQueries[t]=e[t]);await this.debounceExecutePendingGqlQueries()}async refreshStaleDepkeys(e){var t;let n;try{n=await Object(d.a)("/api/get_stale_deps_POST",{json:JSON.stringify({args:[],kwargs:{dependency_to_version:this.depkeyToVersion}})})}catch(h){return}if(Object(y.f)(null===(t=n)||void 0===t?void 0:t.value))return;const s=n.value,i=s.minSeq,o=s.broadcast_id,r=s.channelHash,a=s.netloc,c=s.targetUrl,l=s.depkeys;T.id=o,this.processDepkeyToNewVersion(l,!0),e({minSeq:i,channel:o,channelHash:r,boxName:a,targetUrl:c})}async registerQuery(e,t,n){const s=(e=>{var t,n;return e["default"]&&(e=e["default"]),"Request"===(null===(t=e)||void 0===t?void 0:t.kind)?null===(n=e)||void 0===n?void 0:n.fragment:e})(e),i=m(e);if(s&&i&&n)try{const e=i.hash;this.queryHashToGqlQuery[e]=i;const o={queryHash:e,variables:t},r=await k(o),a=q(s.selections,n,{});Object.keys(a).forEach(e=>{e in this.categoryToGqlQueries||(this.categoryToGqlQueries[e]={}),r in this.categoryToGqlQueries[e]||(this.categoryToGqlQueries[e][r]=o)})}catch(o){Object(r.logJsError)("broadcast->registerQuery",o,{originalError:o})}}async deregisterQuery(e,t){const n=m(e);if(n)try{const e=n.hash,s=await k({queryHash:e,variables:t});for(const t of Object.keys(this.categoryToGqlQueries))s in this.categoryToGqlQueries[t]&&delete this.categoryToGqlQueries[t][s]}catch(s){Object(r.logJsError)("broadcast->deregisterQuery",s,{originalError:s})}}}T.id=null;const q=(e,t,n)=>{if(!t||"object"!==typeof t||t.constructor!==Object)return n;const s=t.id,i=t.__typename;return e.forEach(e=>{switch(e.kind){case"Condition":case"InlineFragment":return void q(e.selections,t,n);case"ScalarField":case"LinkedField":{const o=e.name,r=e.alias?e.alias:e.name,a=t[r];if("id"===o||"__typename"===o||null===a||a===undefined)return;if(e.selections)if(Array.isArray(a))for(const t of a)q(e.selections,t,n);else q(e.selections,a,n);if(s===undefined||null===s||!i||!e.isLive)return;n[`${i}:${o}:${s}`]=!0}}}),n}},ZXlt:function(e,t,n){"use strict";n.r(t),n.d(t,"start",(function(){return u})),n.d(t,"setBeforeReconnectionFn",(function(){return f})),n.d(t,"subscribe",(function(){return y}));var s=n("8lmh"),i=n("mF64"),o=n("s4NR"),r=n.n(o),a=n("Tm8E"),c=n("YS7e");const d=new a.a;let l,h=null;const u=e=>{null===h&&e&&!Object(c.a)()&&"WebSocket"in window&&(h=new b(e),h.start())},f=e=>{l=e},y=(e,t)=>{d.on("tchannel_message",(n,s)=>{e===n&&s&&t(s)})},p=function(e,t){let n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;const s="https:"===Object(i.b)().protocol?"wss:":"ws:";return n?s+"//"+n:[s,"//tch",Math.floor(1e6*Math.random())+1,".tch.",e,"/up/",t,"/updates?"].join("")},_=e=>{try{const t=JSON.parse(e),n=t.message_type,i=t.payload;if(!n||!i)return void Object(s.logJsError)("lib/tchannelClient:_processMessage","Malformed message data (missing message_type and/or payload): "+e);d.trigger("tchannel_message",[n,i])}catch(t){Object(s.logJsError)("lib/tchannelClient:_processMessage","A message is not in JSON format: "+e,{originalError:t})}};class b{constructor(e){let t;this._minSeq=void 0,this._channel=void 0,this._channelHash=void 0,this._boxName=void 0,this._baseHost=void 0,this._targetUrl=void 0,this._socket=void 0,this._isActive=void 0,this._backOffTime=void 0,this._maxBackOffTime=void 0,this._isConnected=void 0,this._minSeq=e.minSeq,this._channel=e.channel,this._channelHash=e.channelHash,this._boxName=e.boxName,this._baseHost=e.baseHost;var n=e.targetUrl;t=void 0===n?null:n,this._minSeq=this._minSeq?parseInt(this._minSeq):0,this._baseHost&&this._boxName&&(this._targetUrl=p(this._baseHost,this._boxName,t)),this._socket=null,this._isActive=!1,this._backOffTime=1e3,this._maxBackOffTime=3e4,window.addEventListener("online",()=>{this._connectWebSocket(!0)}),window.addEventListener("offline",()=>{this._isConnected=!1,this._closeWebSocket()}),window.addEventListener("pageshow",()=>{this._connectWebSocket(!0)}),window.addEventListener("pagehide",()=>{this._isConnected=!1,this._closeWebSocket()})}start(){this._isActive=!0,this._connectWebSocket()}stop(){this._isActive=!1}_updateBackOffTime(){arguments.length>0&&arguments[0]!==undefined&&arguments[0]&&(this._backOffTime=500),this._backOffTime=Math.min(2*this._backOffTime,this._maxBackOffTime)}_connectWebSocket(){let e=arguments.length>0&&arguments[0]!==undefined&&arguments[0];setTimeout(()=>{null===this._socket&&(e&&l?l(this._makeWebSocketRequest.bind(this)):this._makeWebSocketRequest())},this._backOffTime)}_closeWebSocket(){null!==this._socket&&(this._socket.close(1e3),this._socket=null)}_makeWebSocketRequest(){let e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};const t=e.minSeq,n=e.channel,s=e.channelHash,i=e.boxName,o=e.targetUrl;this._minSeq=t!==undefined?parseInt(t):this._minSeq,this._channel=n||this._channel,this._channelHash=s||this._channelHash,this._boxName=i||this._boxName,this._boxName&&this._baseHost&&(this._targetUrl=p(this._baseHost,this._boxName,o));const a=`${this._targetUrl}${r.a.stringify({min_seq:this._minSeq,channel:this._channel,hash:this._channelHash})}`;try{this._socket=new window.WebSocket(a)}catch(c){return void this._onError()}this._socket.onclose=e=>{this._isConnected&&(this._isConnected=!1,this._connectWebSocket(!0))},this._socket.onerror=e=>{this._closeWebSocket(),this._onError()},this._socket.onmessage=e=>{this._onReceivedResponse(JSON.parse(e.data))}}_onReceivedResponse(e){if(this._isActive){this._updateBackOffTime(!0),this._isConnected=!0;try{if(e.error)throw e.error;this._minSeq=parseInt(e.min_seq);for(const t of e.messages)_(t)}catch(t){return}}}_onError(){setTimeout(()=>{this._isActive&&this._updateBackOffTime()},0)}}},kd2E:function(e,t,n){"use strict";function s(e,t){return Object.prototype.hasOwnProperty.call(e,t)}e.exports=function(e,t,n,o){t=t||"&",n=n||"=";var r={};if("string"!==typeof e||0===e.length)return r;var a=/\+/g;e=e.split(t);var c=1e3;o&&"number"===typeof o.maxKeys&&(c=o.maxKeys);var d=e.length;c>0&&d>c&&(d=c);for(var l=0;l<d;++l){var h,u,f,y,p=e[l].replace(a,"%20"),_=p.indexOf(n);_>=0?(h=p.substr(0,_),u=p.substr(_+1)):(h=p,u=""),f=decodeURIComponent(h),y=decodeURIComponent(u),s(r,f)?i(r[f])?r[f].push(y):r[f]=[r[f],y]:r[f]=y}return r};var i=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)}},s4NR:function(e,t,n){"use strict";t.decode=t.parse=n("kd2E"),t.encode=t.stringify=n("4JlD")}}]);